<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Municipal Entry</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="css/style.css" />
</head>
<body class="d-flex vh-100">

  <!-- Sidebar -->
  <aside id="sidebar" class="col-3 p-3 overflow-auto">
    <div class="text-center mb-3">
      <img
        src="https://dbiel-77.github.io/GLOCAL-scraping-guide/_static/logo-dark.png"
        alt="Glocal Logo"
        class="logo mb-2"
      />
      <h2 id="sidebar-title" class="h6">Members</h2>
    </div>
    <ul id="memberList" class="list-unstyled small">
      <li>No members</li>
    </ul>
  </aside>

  <!-- Main Content -->
  <main class="col-9 p-4 overflow-auto">
    <div class="text-center mb-4">
      <h1 id="form-title" class="h5 mb-1">Loading…</h1>
      <p class="text-secondary small">Add members for this region</p>
    </div>

    <form id="memberForm">
    <!-- Personal Info -->
    <section class="mb-4">
        <h5>Personal Info</h5>
        <div class="row gx-2 gy-3">
        <div class="col-4">
            <label for="role" class="form-label">Role</label>
            <input
            type="text"
            id="role"
            class="form-control form-control-sm"
            placeholder="e.g. Councillor"
            />
        </div>
        <div class="col-4">
            <label for="firstName" class="form-label">First Name</label>
            <input
            type="text"
            id="firstName"
            class="form-control form-control-sm"
            placeholder="e.g. Jane"
            />
        </div>
        <div class="col-4">
            <label for="lastName" class="form-label">Last Name</label>
            <input
            type="text"
            id="lastName"
            class="form-control form-control-sm"
            placeholder="e.g. Doe"
            />
        </div>
        <div class="col-4">
            <label for="email" class="form-label">Email Address</label>
            <input
            type="email"
            id="email"
            class="form-control form-control-sm"
            placeholder="name@example.com"
            />
        </div>
        <div class="col-4">
            <label for="groupEmail" class="form-label">Party / Group Email</label>
            <input
            type="email"
            id="groupEmail"
            class="form-control form-control-sm"
            placeholder="office@party.org"
            />
        </div>
        <div class="col-6">
            <label for="photoUrl" class="form-label">Photo URL</label>
            <input
            type="url"
            id="photoUrl"
            class="form-control form-control-sm"
            placeholder="https://example.com/photo.jpg"
            />
        </div>
        <div class="col-6">
            <label for="bio" class="form-label">Short Biography</label>
            <textarea
            id="bio"
            class="form-control form-control-sm"
            rows="2"
            placeholder="Paste a brief bio here…"
            ></textarea>
        </div>
        </div>
    </section>

    <hr />

    <!-- Political Info -->
    <section class="mb-4">
        <h5>Political Info</h5>
        <div class="row gx-2 gy-3">
        <div class="col-6">
            <label for="partyName" class="form-label">Party Name</label>
            <input
            type="text"
            id="partyName"
            class="form-control form-control-sm"
            placeholder="e.g. Green Party (if applicable)"
            />
        </div>
        <div class="col-4">
            <label for="phone" class="form-label">Contact Number</label>
            <input
            type="tel"
            id="phone"
            class="form-control form-control-sm"
            placeholder="e.g. (416) 555-1234"
            />
        </div>
        </div>

        <div class="mb-3">
        <label class="form-label">Office Contact Info</label>
        <div id="officesContainer" class="multivalue-list">
            <div class="input-group input-group-sm mb-1">
            <input
                type="text"
                name="officesKey[]"
                class="form-control"
                placeholder="Type (e.g. Office Phone)"
            />
            <input
                type="text"
                name="officesValue[]"
                class="form-control"
                placeholder="e.g. 416-999-5454 or office@domain.com"
            />
            <button type="button" class="btn btn-outline-secondary btn-sm add-row">+</button>
            <button type="button" class="btn btn-outline-danger btn-sm remove-row">−</button>
            </div>
        </div>
        </div>
    </section>

    <hr />

    <!-- Social Handles -->
    <section class="mb-4">
        <h5>Social Handles (optional)</h5>
        <div class="row gx-2 gy-3">
        <div class="col-4">
            <label for="twitter" class="form-label">Twitter</label>
            <input
            type="text"
            id="twitter"
            class="form-control form-control-sm"
            placeholder="@username or https://twitter.com/username"
            />
        </div>
        <div class="col-4">
            <label for="linkedin" class="form-label">LinkedIn</label>
            <input
            type="url"
            id="linkedin"
            class="form-control form-control-sm"
            placeholder="https://linkedin.com/in/username"
            />
        </div>
        <div class="col-4">
            <label for="instagram" class="form-label">Instagram</label>
            <input
            type="text"
            id="instagram"
            class="form-control form-control-sm"
            placeholder="@username or https://instagram.com/username"
            />
        </div>
        <div class="col-4">
            <label for="facebook" class="form-label">Facebook</label>
            <input
            type="url"
            id="facebook"
            class="form-control form-control-sm"
            placeholder="https://facebook.com/profile"
            />
        </div>
        <div class="col-4">
            <label for="youtube" class="form-label">YouTube</label>
            <input
            type="url"
            id="youtube"
            class="form-control form-control-sm"
            placeholder="https://youtube.com/channel/…"
            />
        </div>
        <div class="col-4">
            <label for="tiktok" class="form-label">TikTok</label>
            <input
            type="text"
            id="tiktok"
            class="form-control form-control-sm"
            placeholder="@username or https://tiktok.com/@username"
            />
        </div>
        </div>
    </section>

    <hr />

    <!-- Links & Misc -->
    <section class="mb-4">
        <h5>Links & Miscellaneous</h5>

        <div class="mb-3">
        <label class="form-label">Role Links</label>
        <div id="roleLinksContainer" class="multivalue-list">
            <div class="input-group input-group-sm mb-1">
            <input
                type="text"
                name="quickLinksKey[]"
                class="form-control"
                placeholder="Link type (e.g. Official Website)"
            />
            <input
                type="url"
                name="quickLinksValue[]"
                class="form-control"
                placeholder="https://example.com"
            />
            <button
                type="button"
                class="btn btn-outline-secondary btn-sm add-row"
            >+</button>
            <button
            type="button"
            class="btn btn-outline-danger btn-sm remove-row"
            >−</button>
            </div>
        </div>
        </div>

        <div class="mb-3">
        <label class="form-label">Personal Links</label>
        <div id="quickLinksContainer" class="multivalue-list">
            <div class="input-group input-group-sm mb-1">
            <input
                type="text"
                name="quickLinksKey[]"
                class="form-control"
                placeholder="Link type (e.g. Personal Website)"
            />
            <input
                type="url"
                name="quickLinksValue[]"
                class="form-control"
                placeholder="https://yourdomain.com"
            />
            <button
                type="button"
                class="btn btn-outline-secondary btn-sm add-row"
            >+</button>
            <button
            type="button"
            class="btn btn-outline-danger btn-sm remove-row"
            >−</button>
            </div>
        </div>
        </div>
    </section>

    </form>


      <hr />

      <div class="d-flex justify-content-end gap-2">
        <button id="addMemberBtn" type="button" class="btn btn-primary btn-sm">Add Member</button>
        <button id="downloadCsvBtn" type="button" class="btn btn-success btn-sm">Download CSV</button>
      </div>
    </form>
  </main>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const province = params.get('province') || '';
    const municipality = params.get('municipality') || '';

    if (!province || !municipality) {
      console.warn('Region not defined in URL');
      return;
    }

    // set page titles
    document.title = `${municipality}, ${province} Members`;
    document.getElementById('form-title').textContent =
      `New Member Form — ${municipality}, ${province}`;
    document.getElementById('sidebar-title').textContent =
      `${municipality}, ${province} Members`;

    const data = [];
    const form = document.getElementById('memberForm');

    // add‐more buttons for multivalue fields
    function setupAddButton(containerId, selector) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.addEventListener('click', e => {
        if (!e.target.matches(selector)) return;
        const template = container.querySelector('.input-group');
        const clone = template.cloneNode(true);
        clone.querySelectorAll('input').forEach(i => i.value = '');
        container.appendChild(clone);
      });
    }
    ['funFacts', 'offices', 'quickLinks'].forEach(name =>
      setupAddButton(name + 'Container', `.add-${name}`)
    );

    // key value pairs for json packing
    function collectPairs(id) {
      const container = document.getElementById(id);
      if (!container) return {};
      return Array.from(container.querySelectorAll('.input-group')).reduce((obj, row) => {
        const key = row.querySelector('input[name$="Key[]"]').value.trim();
        const val = row.querySelector('input[name$="Value[]"]').value.trim();
        if (key) obj[key] = val;
        return obj;
      }, {});
    }

    // list of members on sidebar
    function renderSidebar() {
      const ul = document.getElementById('memberList');
      ul.innerHTML = data.length
        ? data.map(m => `<li>${m.role_type}: ${m.first_name} ${m.last_name}</li>`).join('')
        : '<li>No members</li>';
    }

    function toKebabCase(str) {
        return str
            // turn camelCase → kebab-case
            .replace(/([a-z])([A-Z])/g, '$1-$2')
            // spaces/underscores → hyphens
            .replace(/[\s_]+/g, '-')
            // all lower-case
            .toLowerCase();
    }

    // add member
    document.getElementById('addMemberBtn').addEventListener('click', e => {
      e.preventDefault();
      const getVal = id => (document.getElementById(id)?.value || '').trim();
      //update_date,last_request,personal_url,role_url,election_id,reason_to_run

      const member = {
        id: "",
        politician_id: "",
        is_primary: "",
        name: `${getVal('firstName')} ${getVal('lastName')}`,
        first_name: getVal('firstName'),
        last_name: getVal('lastName'),
        gender: "",
        birth_date: "",
        birth_date_public: "",
        email: getVal('email'),
        group_email: getVal('groupEmail'),
        photo_url: getVal('photoUrl'),
        bio: getVal('bio').replace(/\n/g, '\\n'),
        twitter: getVal('twitter'),
        linkedin: getVal('linkedin'),
        instagram: getVal('instagram'),
        facebook: getVal('facebook'),
        youtube: getVal('youtube'),
        tiktok: getVal('tiktok'),
        fun_facts: "",
        faq: "",
        gallery: "",
        salutation: "",
        gender_pronouns: "",
        party_name: getVal('partyName'),
        gov_level: "municipal",
        province: toKebabCase(province),
        organization: "",
        district_name: toKebabCase(municipality),
        boundary: "",
        offices: collectPairs('officesContainer'),
        quick_links: collectPairs('roleLinksContainer'),
        elected_office: getVal('elected_office'),
        role_type: getVal('role'),
        titles: getVal('titles'),
        policy_priorities: "",
        message_to_constituent: "",
        land_ack: "",
        update_date: "",
        last_request: "",
        personal_url: collectPairs('quickLinksContainer')
      };

      data.push(member);
      renderSidebar();
      form.reset();
    });

    // CSV download
    document.getElementById('downloadCsvBtn').addEventListener('click', () => {
      if (!data.length) {
        alert('No members to download!');
        return;
      }

      const keys = Object.keys(data[0]);

      const csvSafe = v => {
        // if v is a plain object or array, just dump JSON unquoted
        if (typeof v === 'object' && v !== null) {
          return JSON.stringify(v);
        }

        // otherwise turn into a string
        const s = v == null ? '' : String(v);

        // quote if it contains CSV-special chars
        return /[",\r\n]/.test(s)
          ? `"${s.replace(/"/g, '""')}"`
          : s;
      };

      let csv = [
        keys.join(','),
        ...data.map(row =>
          keys.map(k => csvSafe(row[k])).join(',')
        )
      ].join('\r\n');

      csv = csv.replace(/""/g, '"');
      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `members_${province}_${municipality}.csv`;
      link.click();
      URL.revokeObjectURL(link.href);
    });
  });

    document.querySelectorAll('.multivalue-list').forEach(container => {
    container.addEventListener('click', e => {
        const btn   = e.target;
        const row   = btn.closest('.input-group');
        if (!row) return;

        // ADD ROW
        if (btn.classList.contains('add-row')) {
        const clone = row.cloneNode(true);
        clone.querySelectorAll('input').forEach(i => i.value = '');
        container.appendChild(clone);
        return;
        }

        // REMOVE ROW
        if (btn.classList.contains('remove-row')) {
        const rows = container.querySelectorAll('.input-group');
        if (rows.length > 1) {
            row.remove();
        } else {
            // if only one left, just clear its inputs
            row.querySelectorAll('input').forEach(i => i.value = '');
        }
        }
    });
    });

  </script>

</body>
</html>
