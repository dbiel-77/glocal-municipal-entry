<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Municipal Entry</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="css/style.css" />
</head>
<body class="d-flex vh-100">

  <!-- Sidebar -->
  <aside id="sidebar" class="col-3 p-3 overflow-auto">
    <div class="text-center mb-3">
      <img
        src="https://dbiel-77.github.io/GLOCAL-scraping-guide/_static/logo-dark.png"
        alt="Glocal Logo"
        class="logo mb-2"
      />
      <h2 id="sidebar-title" class="h6">Members</h2>
    </div>
    <ul id="memberList" class="list-unstyled small">
      <li>No members</li>
    </ul>
  </aside>

  <!-- Main Content -->
  <main class="col-9 p-4 overflow-auto">
    <form id="memberForm">
    <!-- Personal Info -->
    <section class="mb-4">
        <h5>Personal Info</h5>
        <div class="row gx-2 gy-3">
        <div class="col-4">
            <label for="role" class="form-label">Role</label>
            <input
            type="text"
            id="role"
            class="form-control form-control-sm"
            placeholder="e.g. Councillor"
            />
        </div>
        <div class="col-4">
            <label for="firstName" class="form-label">First Name</label>
            <input
            type="text"
            id="firstName"
            class="form-control form-control-sm"
            placeholder="e.g. Jane"
            required
            />
        </div>
        <div class="col-4">
            <label for="lastName" class="form-label">Last Name</label>
            <input
            type="text"
            id="lastName"
            class="form-control form-control-sm"
            placeholder="e.g. Doe"
            required
            />
        </div>
        <div class="col-4">
            <label for="email" class="form-label">Email Address</label>
            <input
            type="email"
            id="email"
            class="form-control form-control-sm"
            placeholder="name@example.com"
            />
        </div>
        <div class="col-4">
            <label for="groupEmail" class="form-label">Party / Group Email</label>
            <input
            type="email"
            id="groupEmail"
            class="form-control form-control-sm"
            placeholder="office@party.org"
            />
        </div>
        <div class="col-6">
            <label for="photoUrl" class="form-label">Photo URL</label>
            <input
            type="url"
            id="photoUrl"
            class="form-control form-control-sm"
            placeholder="https://example.com/photo.jpg"
            />
        </div>
        <div class="col-6">
            <label for="bio" class="form-label">Short Biography</label>
            <textarea
            id="bio"
            class="form-control form-control-sm"
            rows="2"
            placeholder="Paste a brief bio here…"
            ></textarea>
        </div>
        </div>
    </section>

    <hr />

    <!-- Political Info -->
    <section class="mb-4">
        <h5>Political Info</h5>
        <div class="row gx-2 gy-3">
        <div class="col-6">
            <label for="partyName" class="form-label">Party Name</label>
            <input
            type="text"
            id="partyName"
            class="form-control form-control-sm"
            placeholder="e.g. Green Party (if applicable)"
            />
        </div>
        <div class="col-4">
            <label for="phone" class="form-label">Contact Number</label>
            <input
            type="tel"
            id="phone"
            class="form-control form-control-sm"
            placeholder="e.g. (416) 555-1234"
            />
        </div>
        </div>

        <div class="mb-3">
        <label class="form-label">Office Contact Info</label>
        <div id="officesContainer" class="multivalue-list">
          <div class="row input-group input-group-sm mb-2">
            <div class="col-3">
              <input type="text" name="officeTel[]" class="form-control" placeholder="Telephone" />
            </div>
            <div class="col-3">
              <input type="text" name="officeFax[]" class="form-control" placeholder="Fax" />
            </div>
            <div class="col-3">
              <input type="text" name="officeType[]" class="form-control" placeholder="Type (legislature, constituency, blank if not sure)" />
            </div>
            <div class="col-3">
              <input type="text" name="officePostal[]" class="form-control" placeholder="Postal Address" />
            </div>
          </div>
        </div>
    </section>

    <hr />

    <!-- Social Handles -->
    <section class="mb-4">
        <h5>Social Handles</h5>
        <div class="row gx-2 gy-3">
        <div class="col-4">
            <label for="twitter" class="form-label">Twitter</label>
            <input
            type="text"
            id="twitter"
            class="form-control form-control-sm"
            placeholder="@username or https://twitter.com/username"
            />
        </div>
        <div class="col-4">
            <label for="linkedin" class="form-label">LinkedIn</label>
            <input
            type="url"
            id="linkedin"
            class="form-control form-control-sm"
            placeholder="https://linkedin.com/in/username"
            />
        </div>
        <div class="col-4">
            <label for="instagram" class="form-label">Instagram</label>
            <input
            type="text"
            id="instagram"
            class="form-control form-control-sm"
            placeholder="@username or https://instagram.com/username"
            />
        </div>
        <div class="col-4">
            <label for="facebook" class="form-label">Facebook</label>
            <input
            type="url"
            id="facebook"
            class="form-control form-control-sm"
            placeholder="https://facebook.com/profile"
            />
        </div>
        <div class="col-4">
            <label for="youtube" class="form-label">YouTube</label>
            <input
            type="url"
            id="youtube"
            class="form-control form-control-sm"
            placeholder="https://youtube.com/channel/…"
            />
        </div>
        <div class="col-4">
            <label for="tiktok" class="form-label">TikTok</label>
            <input
            type="text"
            id="tiktok"
            class="form-control form-control-sm"
            placeholder="@username or https://tiktok.com/@username"
            />
        </div>
        </div>
    </section>

    <hr />

    <!-- Links & Misc -->
    <section class="mb-4">
      <h5>Links & Miscellaneous</h5>

      <div class="mb-3">
        <label class="form-label">Role Links</label>
        <div id="roleLinksContainer" class="multivalue-list">
          <div class="row input-group input-group-sm mb-1">
            <div class="col-5">
              <input type="text" name="roleLinkTitle[]" class="form-control" placeholder="Title (e.g. Official Website)" />
            </div>
            <div class="col-5">
              <input type="url" name="roleLinkUrl[]" class="form-control" placeholder="https://example.com" />
            </div>
            <div class="col-auto">
              <button type="button" class="btn btn-outline-secondary btn-sm add-row">+</button>
              <button type="button" class="btn btn-outline-danger btn-sm remove-row">−</button>
            </div>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Personal Links</label>
        <div id="quickLinksContainer" class="multivalue-list">
          <div class="row input-group input-group-sm mb-1">
            <div class="col-5">
              <input type="text" name="personalLinkTitle[]" class="form-control" placeholder="Title (e.g. Portfolio)" />
            </div>
            <div class="col-5">
              <input type="url" name="personalLinkUrl[]" class="form-control" placeholder="https://yourdomain.com" />
            </div>
            <div class="col-auto">
              <button type="button" class="btn btn-outline-secondary btn-sm add-row">+</button>
              <button type="button" class="btn btn-outline-danger btn-sm remove-row">−</button>
            </div>
          </div>
        </div>
      </div>
    </section>
    </form>
      <hr />
      <div class="d-flex justify-content-end gap-2">
        <button id="addMemberBtn" type="button" class="btn btn-primary btn-sm">Add Member</button>
        <button id="downloadCsvBtn" type="button" class="btn btn-success btn-sm">Download JSON</button>
      </div>
    </form>
  </main>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const province = params.get('province') || '';
      const municipality = params.get('municipality') || '';

      if (!province || !municipality) {
        console.warn('Region not defined in URL');
        return;
      }

      document.title = `${municipality}, ${province} Members`;
      const titleEl = document.getElementById('form-title');
      if (titleEl) titleEl.textContent = `New Member Form — ${municipality}, ${province}`;
      const sidebarTitleEl = document.getElementById('sidebar-title');
      if (sidebarTitleEl) sidebarTitleEl.textContent = `${municipality}, ${province} Members`;

      const form = document.getElementById('memberForm');
      const imported = sessionStorage.getItem('importedMembers');
      const data = imported ? JSON.parse(imported) : [];
      let currentEditIndex = null;

      function toKebabCase(str) {
        return str.replace(/([a-z])([A-Z])/g, '$1-$2')
                  .replace(/[\s_]+/g, '-')
                  .toLowerCase();
      }

      function getVal(id) {
        return (document.getElementById(id)?.value || '').trim();
      }

      function renderSidebar() {
        const ul = document.getElementById('memberList');
        ul.innerHTML = '';

        if (!data.length) {
          ul.innerHTML = '<li>No members</li>';
          return;
        }

        data.forEach((m, idx) => {
          const li = document.createElement('li');
          li.className = 'member-entry d-flex align-items-center gap-2 rounded px-2 py-1 mb-2 text-light';
          li.style.background = 'rgba(255,255,255,0.05)';
          li.style.cursor = 'pointer';

          if (idx === currentEditIndex) {
            li.style.borderLeft = '4px solid #0d6efd';
            li.style.background = 'rgba(255,255,255,0.15)';
          }

          const img = document.createElement('img');
          img.src = m.photo_url || 'https://via.placeholder.com/32';
          img.width = 32;
          img.height = 32;
          img.className = 'rounded-circle';

          const div = document.createElement('div');
          div.innerHTML = `<div class=\"fw-semibold small\">${m.role_type || 'Role'}</div><div class=\"text-white-50 small\">${m.first_name} ${m.last_name}</div>`;

          li.appendChild(img);
          li.appendChild(div);

          li.addEventListener('click', () => loadMemberToForm(idx));
          ul.appendChild(li);
        });

        const addNew = document.createElement('li');
        addNew.className = 'd-flex align-items-center justify-center gap-2 rounded px-2 py-2 text-center text-light fw-bold';
        addNew.style.background = 'rgba(0,123,255,0.15)';
        addNew.style.cursor = 'pointer';
        addNew.textContent = '+ Add New Member';
        addNew.addEventListener('click', () => {
          form.reset();
          currentEditIndex = null;
          renderSidebar();
        });
        ul.appendChild(addNew);
      }

      function loadMemberToForm(index) {
        const m = data[index];
        if (!m) return;

        currentEditIndex = index;

        document.getElementById('firstName').value = m.first_name || '';
        document.getElementById('lastName').value = m.last_name || '';
        document.getElementById('email').value = m.email || '';
        document.getElementById('groupEmail').value = m.group_email || '';
        document.getElementById('photoUrl').value = m.photo_url || '';
        document.getElementById('bio').value = (m.bio || '').replace(/\\n/g, '\n');
        document.getElementById('role').value = m.role_type || '';
        document.getElementById('partyName').value = m.party_name || '';
      }

      function setupAddButton(containerId, selector) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.addEventListener('click', e => {
          if (!e.target.matches(selector)) return;
          const template = container.querySelector('.input-group');
          const clone = template.cloneNode(true);
          clone.querySelectorAll('input').forEach(i => i.value = '');
          container.appendChild(clone);
        });
      }

      function collectLinks(containerId, titleName, urlName) {
        const container = document.getElementById(containerId);
        if (!container) return [];
        return Array.from(container.querySelectorAll('.input-group')).map(row => {
          const title = row.querySelector(`input[name=\"${titleName}\"]`)?.value.trim();
          const url = row.querySelector(`input[name=\"${urlName}\"]`)?.value.trim();
          return (title && url) ? { title, url } : null;
        }).filter(Boolean);
      }

      function collectOffices() {
        const container = document.getElementById('officesContainer');
        if (!container) return [];
        return Array.from(container.querySelectorAll('.input-group')).map(row => {
          const tel = row.querySelector('input[name="officeTel[]"]')?.value.trim();
          const fax = row.querySelector('input[name="officeFax[]"]')?.value.trim();
          const type = row.querySelector('input[name="officeType[]"]')?.value.trim();
          const postal = row.querySelector('input[name="officePostal[]"]')?.value.trim();
          const entry = {};
          if (tel) entry.tel = tel;
          if (fax) entry.fax = fax;
          if (type) entry.type = type;
          if (postal) entry.postal = postal;
          return Object.keys(entry).length ? entry : null;
        }).filter(Boolean);
      }

      document.querySelectorAll('.multivalue-list').forEach(container => {
        container.addEventListener('click', e => {
          const btn = e.target;
          const row = btn.closest('.input-group');
          if (!row) return;

          if (btn.classList.contains('add-row')) {
            const clone = row.cloneNode(true);
            clone.querySelectorAll('input').forEach(i => i.value = '');
            container.appendChild(clone);
          } else if (btn.classList.contains('remove-row')) {
            const rows = container.querySelectorAll('.input-group');
            if (rows.length > 1) {
              row.remove();
            } else {
              row.querySelectorAll('input').forEach(i => i.value = '');
            }
          }
        });
      });

      document.getElementById('addMemberBtn').addEventListener('click', e => {
        e.preventDefault();

        const member = {
          id: '',
          politician_id: '',
          is_primary: '',
          name: `${getVal('firstName')} ${getVal('lastName')}`,
          first_name: getVal('firstName'),
          last_name: getVal('lastName'),
          gender: '',
          birth_date: '',
          birth_date_public: '',
          email: getVal('email'),
          group_email: getVal('groupEmail'),
          photo_url: getVal('photoUrl'),
          bio: getVal('bio').replace(/\n/g, '\\n'),
          twitter: getVal('twitter'),
          linkedin: getVal('linkedin'),
          instagram: getVal('instagram'),
          facebook: getVal('facebook'),
          youtube: getVal('youtube'),
          tiktok: getVal('tiktok'),
          fun_facts: '',
          faq: '',
          gallery: '',
          salutation: '',
          gender_pronouns: '',
          party_name: getVal('partyName'),
          gov_level: 'municipal',
          province: toKebabCase(province),
          organization: '',
          district_name: toKebabCase(municipality),
          boundary: '',
          offices: collectOffices(),
          quick_links: collectLinks('roleLinksContainer', 'roleLinkTitle[]', 'roleLinkUrl[]'),
          elected_office: getVal('elected_office'),
          role_type: getVal('role'),
          titles: getVal('titles'),
          policy_priorities: '',
          message_to_constituent: '',
          land_ack: '',
          update_date: '',
          last_request: '',
          personal_url: collectLinks('quickLinksContainer', 'personalLinkTitle[]', 'personalLinkUrl[]')
        };

        if (currentEditIndex !== null) {
          data[currentEditIndex] = member;
          currentEditIndex = null;
        } else {
          data.push(member);
        }

        renderSidebar();
        form.reset();
      });

      document.getElementById('downloadCsvBtn').addEventListener('click', () => {
        if (!data.length) {
          alert('No members to download!');
          return;
        }
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `members_${province}_${municipality}.json`;
        link.click();
        URL.revokeObjectURL(link.href);
      });

      setupAddButton('officesContainer', '.add-row');
      setupAddButton('quickLinksContainer', '.add-row');
      setupAddButton('roleLinksContainer', '.add-row');

      if (data.length > 0) renderSidebar();
    });
  </script>


</body>
</html>
